<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.state.dao.ILoginDao">

	<select id="judgeUser" resultType="UserPo">
		select u.ID_ as id,u.USER_ID_ as userId,u.*,u.is_login islogin from <include refid='public.model' /> CBPM_USER u where (mname=#{user} or USER_ID_=#{user}) and mkey=#{password}
	</select>

	<select id="containUser" resultType="UserPo">
		select u.ID_ as id,u.*,u.is_login islogin from <include refid='public.model' /> CBPM_USER u where mname=#{user}
	</select>
	
	<delete id="deleteUser" parameterType="String">
    	delete from <include refid='public.model' /> CBPM_USER where ID_ = #{id}
  	</delete>
	
	
	<select id="selectNopass" resultType="UserPo">
		select u.ID_ as id,u.*,u.is_login islogin from <include refid='public.model' /> CBPM_USER u where u.is_login='0' order by mname 
	</select>

	<!-- <select id="selectPass" resultType="UserPo">
		select u.*,u.is_login islogin from <include refid='public.model' /> CBPM_USER u where u.is_login='1' and u.mname not in ('国调') order by mname 
	</select> -->
	<select id="selectPass" resultType="UserPo">
		select u.ID_ as id,u.USER_ID_ as userId,
		<include refid="selectRoleName"/> as roleName
		,u.*,u.is_login islogin from <include refid='public.model' /> CBPM_USER u  order by mname 
	</select>
	<select id="selectBill" resultType="Map">
		select b.mname as "mname",b.url as "url" from <include refid='public.model' /> CBPM_BILL_USER a inner join <include refid='public.model' /> CBPM_BILL b on a.bill_id=b.id where a.mname=#{user} order by a.bill_id;
	</select>
	
	<sql id="selectRoleName">  
    	(select top 1 r.ROLE_NAME_ from <include refid='public.model' /> ORG_ROLE r where r.ID_ in (select ROLE_UID_ from <include refid='public.model' /> ORG_USER_ROLE our where our.USER_UID_=u.ID_))
  	</sql>
	
	<update id="updateUser" parameterType="String">
		update CBPM_USER 
		<set> 
			is_login=#{state}
		</set> 
		where mname=#{name}
	</update>
	
	<insert id="saveUser">
		insert into CBPM_USER (ID_,USER_ID_,mname,area,mkey,dtype,is_login,drole) values
		(#{id},#{userId},#{user},#{area},#{password},'省','0',#{sf})
	</insert>
	
	<update id="approve">
		update CBPM_USER
		<set> 
			is_login='1'
		</set> 
		where mname=#{user}
	</update>
	
	<insert id="allotBill">
		insert into CBPM_BILL_USER (mname,bill_id) values (#{user},#{num})
	</insert>
	
	<select id="getNumUser" resultType="String">
		select count(u.DROLE) from <include refid='public.model' /> CBPM_USER u where u.DROLE='buy' union all select count(b.DROLE) from <include refid='public.model' /> CBPM_USER b where b.DROLE='sale'
	</select>
	<select id="getCountByType" resultType="TypePo">
		select * from <include refid='public.model' /> CBPM_TYPE
	</select>
	
	<select id="getPssCount" resultType="java.lang.Long">
		select count(*)  from <include refid='public.model' /> CBPM_USER u  order by mname 
	</select>
	
<select id="selectPassCurrentPage" resultType="UserPo">
		select *
		from (select a.*, rownum rnum
		from (select u.ID_ as id,u.USER_ID_ as userId,
		<include refid="selectRoleName"/> as roleName
		,u.*,u.is_login islogin from <include refid='public.model' /> CBPM_USER u  order by DOC_CREATED_ desc) a
		where rownum &lt;= (#{currentPage,jdbcType=INTEGER}+1)*#{limit} )
		where rnum &gt; #{currentPage,jdbcType=INTEGER}*#{limit}; 
	</select>
</mapper>